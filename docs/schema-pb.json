{
  "database": "supabase_postgres",
  "version": "1.2.0",
  "updated": "2025-07-22T13:10:00.000Z",
  "tables": {
    "places": {
      "description": "Stores venue/place information fetched from ScaleSerp API",
      "columns": {
        "id": {
          "type": "UUID",
          "primary_key": true,
          "default": "gen_random_uuid()",
          "description": "Unique identifier for the place"
        },
        "created_at": {
          "type": "TIMESTAMPTZ",
          "nullable": false,
          "default": "NOW()",
          "description": "Timestamp when the record was created"
        },
        "updated_at": {
          "type": "TIMESTAMPTZ",
          "nullable": false,
          "default": "NOW()",
          "description": "Timestamp when the record was last updated"
        },
        "title": {
          "type": "TEXT",
          "nullable": false,
          "description": "Name/title of the place"
        },
        "data_cid": {
          "type": "TEXT",
          "nullable": true,
          "description": "ScaleSerp data CID identifier for the place"
        },
        "knowledge_graph_id": {
          "type": "TEXT",
          "nullable": true,
          "description": "Google Knowledge Graph ID for the place"
        },
        "address": {
          "type": "TEXT",
          "nullable": true,
          "description": "Street address of the place"
        },
        "category": {
          "type": "TEXT",
          "nullable": true,
          "description": "Business category (e.g., 'Night club', 'Bar')"
        },
        "location": {
          "type": "GEOGRAPHY(POINT, 4326)",
          "nullable": true,
          "description": "PostGIS geography point for GPS coordinates"
        },
        "latitude": {
          "type": "DECIMAL(10, 8)",
          "nullable": true,
          "description": "Latitude coordinate (fallback/compatibility)"
        },
        "longitude": {
          "type": "DECIMAL(11, 8)",
          "nullable": true,
          "description": "Longitude coordinate (fallback/compatibility)"
        },
        "city": {
          "type": "TEXT",
          "nullable": false,
          "description": "City where the place is located"
        },
        "state": {
          "type": "TEXT",
          "nullable": false,
          "description": "State where the place is located"
        },
        "country": {
          "type": "TEXT",
          "default": "'United States'",
          "description": "Country where the place is located"
        },
        "rating": {
          "type": "DECIMAL(3, 2)",
          "nullable": true,
          "constraints": "CHECK (rating >= 0 AND rating <= 5)",
          "description": "Average rating (0-5 scale)"
        },
        "reviews": {
          "type": "INTEGER",
          "nullable": true,
          "constraints": "CHECK (reviews >= 0)",
          "description": "Number of reviews"
        },
        "phone": {
          "type": "TEXT",
          "nullable": true,
          "description": "Phone number"
        },
        "sponsored": {
          "type": "BOOLEAN",
          "default": false,
          "description": "Whether the listing is sponsored"
        },
        "extensions": {
          "type": "JSONB",
          "nullable": true,
          "description": "Additional metadata from search results"
        },
        "price": {
          "type": "TEXT",
          "nullable": true,
          "description": "Price range indicator (e.g., '$', '$$', '$$$')"
        },
        "price_parsed": {
          "type": "INTEGER",
          "nullable": true,
          "description": "Numeric price level (1-4)"
        },
        "price_description": {
          "type": "TEXT",
          "nullable": true,
          "description": "Textual price description"
        },
        "position": {
          "type": "INTEGER",
          "nullable": true,
          "description": "Position in search results"
        },
        "search_query": {
          "type": "TEXT",
          "nullable": false,
          "default": "'night clubs'",
          "description": "Search query used to find this place"
        },
        "source": {
          "type": "TEXT",
          "nullable": false,
          "default": "'scaleserp'",
          "description": "Data source (scaleserp, valueserp, etc.)"
        },
        "photos": {
          "type": "JSONB",
          "nullable": true,
          "default": "'[]'::jsonb",
          "constraints": "CHECK (jsonb_typeof(photos) = 'array')",
          "description": "Array of photo objects with URLs and metadata",
          "schema": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "url": {
                  "type": "string",
                  "description": "Full-size image URL"
                },
                "thumbnail": {
                  "type": "string",
                  "description": "Thumbnail image URL"
                },
                "width": {
                  "type": "integer",
                  "description": "Image width in pixels"
                },
                "height": {
                  "type": "integer",
                  "description": "Image height in pixels"
                },
                "source": {
                  "type": "string",
                  "description": "Source of the photo (e.g., 'scaleserp')"
                }
              }
            }
          }
        }
      },
      "indexes": [
        {
          "name": "idx_places_location",
          "type": "GIST",
          "columns": ["location"],
          "description": "Spatial index for location queries"
        },
        {
          "name": "idx_places_city_state",
          "columns": ["city", "state"],
          "description": "Index for city/state queries"
        },
        {
          "name": "idx_places_category",
          "columns": ["category"],
          "description": "Index for category filtering"
        },
        {
          "name": "idx_places_rating",
          "columns": ["rating DESC"],
          "description": "Index for rating-based sorting"
        },
        {
          "name": "idx_places_created_at",
          "columns": ["created_at DESC"],
          "description": "Index for chronological queries"
        },
        {
          "name": "idx_places_location_fallback",
          "columns": ["latitude", "longitude"],
          "description": "Fallback index for lat/lng queries"
        },
        {
          "name": "idx_places_photos",
          "type": "GIN",
          "columns": ["photos"],
          "description": "Index for photos JSONB queries"
        }
      ],
      "unique_constraints": [
        {
          "name": "idx_places_unique",
          "columns": ["title", "address", "city", "state"],
          "condition": "WHERE address IS NOT NULL",
          "description": "Prevent duplicate places with addresses"
        },
        {
          "name": "idx_places_unique_no_address",
          "columns": ["title", "city", "state"],
          "condition": "WHERE address IS NULL",
          "description": "Prevent duplicate places without addresses"
        }
      ],
      "triggers": [
        {
          "name": "trigger_update_places_location",
          "event": "BEFORE INSERT OR UPDATE",
          "function": "update_places_location()",
          "description": "Automatically updates PostGIS location from lat/lng and updated_at timestamp"
        }
      ],
      "functions": [
        {
          "name": "insert_place_with_coordinates",
          "description": "Helper function for inserting places with coordinate validation",
          "parameters": [
            "p_title TEXT",
            "p_latitude DECIMAL",
            "p_longitude DECIMAL",
            "p_address TEXT DEFAULT NULL",
            "p_city TEXT DEFAULT NULL",
            "p_state TEXT DEFAULT NULL",
            "p_category TEXT DEFAULT NULL",
            "p_rating DECIMAL DEFAULT NULL",
            "p_reviews INTEGER DEFAULT NULL",
            "p_phone TEXT DEFAULT NULL",
            "p_data_cid TEXT DEFAULT NULL",
            "p_knowledge_graph_id TEXT DEFAULT NULL",
            "p_sponsored BOOLEAN DEFAULT FALSE",
            "p_extensions JSONB DEFAULT NULL",
            "p_price TEXT DEFAULT NULL",
            "p_price_parsed INTEGER DEFAULT NULL",
            "p_price_description TEXT DEFAULT NULL",
            "p_position INTEGER DEFAULT NULL",
            "p_search_query TEXT DEFAULT 'night clubs'",
            "p_source TEXT DEFAULT 'scaleserp'",
            "p_photos JSONB DEFAULT '[]'::jsonb"
          ],
          "returns": "UUID"
        }
      ],
      "policies": [
        {
          "name": "Allow read access to places",
          "type": "SELECT",
          "condition": "true",
          "description": "Allow public read access to all places"
        },
        {
          "name": "Allow full access for service role",
          "type": "ALL",
          "condition": "auth.role() = 'service_role'",
          "description": "Allow full access for service role"
        },
        {
          "name": "Allow authenticated users to read places",
          "type": "SELECT",
          "condition": "auth.role() = 'authenticated'",
          "description": "Allow authenticated users to read places"
        }
      ]
    }
  },
  "extensions": [
    {
      "name": "postgis",
      "description": "PostGIS extension for geographic data types and functions"
    }
  ],
  "api_integration": {
    "scaleserp": {
      "base_url": "https://api.scaleserp.com/search",
      "search_types": [
        {
          "type": "places",
          "description": "Search for places/businesses",
          "parameters": {
            "api_key": "required",
            "search_type": "places",
            "q": "search query",
            "location": "geographic location",
            "google_domain": "google.com",
            "gl": "country code",
            "hl": "language code",
            "num": "results per page",
            "start": "pagination offset"
          }
        },
        {
          "type": "place_photos",
          "description": "Fetch photos for a specific place",
          "parameters": {
            "api_key": "required",
            "search_type": "place_photos",
            "data_id": "place data_id from places search",
            "hl": "language code"
          }
        }
      ]
    }
  },
  "data_flow": {
    "venue_generation": {
      "description": "Process for generating venue data using ScaleSerp API",
      "steps": [
        "Load city data from JSON files",
        "For each city, fetch places using ScaleSerp places API",
        "For each place with data_cid, fetch photos using ScaleSerp place_photos API",
        "Transform API data to database schema",
        "Insert places with photos into database",
        "Handle duplicates using unique constraints"
      ]
    }
  }
}