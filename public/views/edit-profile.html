<div class="profile-container">

  <div class="profile-header">
    <h1 data-i18n="">Update Profile Info</h1>
    <a href="#" class="skip-btn" data-i18n="">Go back</a>
  </div>
  
  <div class="profile-photo-container">
    <div class="profile-photo">
      <img src="/images/default-profile.png" alt="Profile Photo" id="profile-image">
      <button class="camera-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M23 19C23 19.5304 22.7893 20.0391 22.4142 20.4142C22.0391 20.7893 21.5304 21 21 21H3C2.46957 21 1.96086 20.7893 1.58579 20.4142C1.21071 20.0391 1 19.5304 1 19V8C1 7.46957 1.21071 6.96086 1.58579 6.58579C1.96086 6.21071 2.46957 6 3 6H7L9 3H15L17 6H21C21.5304 6 22.0391 6.21071 22.4142 6.58579C22.7893 6.96086 23 7.46957 23 8V19Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M12 17C14.2091 17 16 15.2091 16 13C16 10.7909 14.2091 9 12 9C9.79086 9 8 10.7909 8 13C8 15.2091 9.79086 17 12 17Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
    <div class="profile-photo-text" data-i18n="profile.photo">Profile Photo</div>
  </div>
  
  <div class="profile-form">
    <div class="input-group">
      <label for="first-name" data-i18n="profile.first_name">First name</label>
      <input type="text" id="first-name" placeholder="Jane" data-i18n-placeholder="profile.first_name_placeholder">
    </div>
    
    <div class="input-group">
      <label for="last-name" data-i18n="profile.last_name">Last name</label>
      <input type="text" id="last-name" placeholder="Doe" data-i18n-placeholder="profile.last_name_placeholder">
    </div>

    <div class="input-group">
      <label for="phone-number" data-i18n="profile.phone_number">Phone number</label>
      <div class="phone-input-container">
        <div class="country-select" id="country-select">
          <div class="selected-country">
            <div class="country-flag" id="selected-flag">ðŸ‡ºðŸ‡¸</div>
            <div class="country-code" id="selected-code">+1</div>
            <div class="dropdown-arrow">â–¼</div>
          </div>
          <div class="country-dropdown" id="country-dropdown" style="display: none;">
            <div class="country-search-container">
              <input type="text" id="country-search-input" placeholder="Search country" class="country-search" data-i18n-placeholder="profile.search_country">
            </div>
            <div class="country-list-container">
              <!-- Country options will be populated dynamically from countries.js -->
            </div>
          </div>
        </div>
        <input type="tel" id="phone-number" placeholder="123-456-7890" class="phone-input" data-i18n-placeholder="profile.phone_placeholder">
        <input type="hidden" id="country-code-input" value="+1">
        <input type="hidden" id="full-phone" value="">
      </div>
    </div>
    
    <button class="option-btn birthday-btn" id="birthday-btn" type="button" onclick="showDatePicker()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M19 4H5C3.89543 4 3 4.89543 3 6V20C3 21.1046 3.89543 22 5 22H19C20.1046 22 21 21.1046 21 20V6C21 4.89543 20.1046 4 19 4Z" stroke="#F44B74" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M16 2V6" stroke="#F44B74" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M8 2V6" stroke="#F44B74" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M3 10H21" stroke="#F44B74" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span>Choose birthday date</span>
    </button>
    
    <button class="option-btn location-btn" id="location-btn" type="button">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 7.61305 3.94821 5.32387 5.63604 3.63604C7.32387 1.94821 9.61305 1 12 1C14.3869 1 16.6761 1.94821 18.364 3.63604C20.0518 5.32387 21 7.61305 21 10Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M12 13C13.6569 13 15 11.6569 15 10C15 8.34315 13.6569 7 12 7C10.3431 7 9 8.34315 9 10C9 11.6569 10.3431 13 12 13Z" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span>Choose your location</span>
    </button>
    
    <button class="confirm-btn" id="confirm-btn">Confirm</button>
  </div>
</div>
<style>
  /* Import Roboto font */
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
  /* Import country dropdown styles */
  @import url('/css/country-dropdown.css');
  
  .profile-container {
    display: flex;
    flex-direction: column;
    width: 100%;
    min-height: 100vh;
    background-color: #fff;
    font-family: 'Roboto', sans-serif;
    padding: 16px;
    padding-top: 0;
    box-sizing: border-box;
  }
  
  .profile-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-top: 16px;
  }
  
  .profile-header h1 {
    font-size: 18px;
    font-weight: 500;
    margin: 0;
    color: #333;
  }
  
  .skip-btn {
    color: #F44B74;
    font-size: 14px;
    font-weight: 400;
    text-decoration: none;
  }
  
  .profile-photo-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 30px;
  }
  
  .profile-photo {
    position: relative;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    overflow: hidden;
    background-color: #f3f3f3;
    margin-bottom: 8px;
    border: 1px solid #eaeaea;
  }
  
  .profile-photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .profile-photo-text {
    font-size: 13px;
    color: #888;
    text-align: center;
  }
  
  .camera-btn {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background-color: #F44B74;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    padding: 0;
  }
  
  .camera-btn svg {
    width: 14px;
    height: 14px;
  }
  
  .profile-form {
    display: flex;
    flex-direction: column;
    width: 100%;
    margin: 0 auto;
  }
  
  .input-group {
    margin-bottom: 15px;
  }
  
  .input-group label {
    display: block;
    font-size: 12px;
    color: #888;
    margin-bottom: 4px;
  }
  
  .input-group input {
    width: 100%;
    height: 42px;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    padding: 0 15px;
    font-size: 16px;
    box-sizing: border-box;
    color: #333;
    background-color: #fff;
  }
  
  /* Phone input styles moved to country-dropdown.css */
  
  .option-btn {
    display: flex;
    align-items: center;
    width: 100%;
    height: 44px;
    border-radius: 8px;
    border: none;
    background-color: #f9f9f9;
    margin-bottom: 12px;
    padding: 0 15px;
    font-size: 14px;
    cursor: pointer;
    text-align: left;
    box-shadow: none;
  }
  
  .option-btn svg {
    margin-right: 10px;
    width: 18px;
    height: 18px;
  }
  
  .birthday-btn span {
    color: #F44B74;
  }
  
  .option-btn.has-value {
    background-color: rgba(248, 92, 138, 0.05);
    border: 1px solid rgba(248, 92, 138, 0.1);
  }
  
  .location-btn span {
    color: #333;
  }
  
  .confirm-btn {
    width: 100%;
    height: 44px;
    border-radius: 22px;
    border: none;
    background-color: #F44B74;
    color: white;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    margin-top: 30px;
    box-shadow: 0 2px 8px rgba(248, 92, 138, 0.3);
  }
  
  @media (max-width: 600px) {
    .profile-header h1 {
      font-size: 17px;
    }
  }
  
  /* Date Picker Styles */
  .date-picker-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: flex-end;
    justify-content: center;
  }
  
  .date-picker-container {
    background-color: white;
    border-radius: 20px 20px 0 0;
    width: 100%;
    max-width: 100%;
    padding: 24px;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    align-items: center;
    transform: translateY(100%);
    transition: transform 0.3s ease-out;
  }
  
  .date-picker-modal.visible .date-picker-container {
    transform: translateY(0);
  }
  
  .date-picker-container h2 {
    font-size: 18px;
    color: #333;
    margin: 0 0 20px;
    font-weight: 500;
    text-align: center;
  }
  
  .year-month-selector {
    display: block;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    margin-bottom: 20px;
  }
  
  .year-month-selector > div {
    text-align: center;
  }
  
  .handle-bar {
    width: 40px;
    height: 4px;
    background-color: #ddd;
    border-radius: 2px;
    margin-bottom: 16px;
  }

  .selected-year {
    font-size: 20px;
    font-weight: 700;
    color: #F44B74;
    margin-bottom: 4px;
    cursor: pointer;
  }
  
  .selected-month {
    font-size: 22px;
    color: #F44B74;
    font-weight: 400;
  }
  
  .year-selector, .month-selector {
    display: none;
    width: 100%;
    margin-bottom: 20px;
    max-height: 300px;
  }
  
  .selector-title {
    text-align: center;
    font-size: 18px;
    font-weight: 500;
    margin: 10px 0;
    color: #333;
  }
  
  .year-scroll-container, .month-scroll-container {
    height: 220px;
    overflow-y: scroll;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: y mandatory;
    padding: 60px 0;
    margin: 0 auto;
    width: 100%;
    position: relative;
    background: linear-gradient(
      to bottom,
      white 0%,
      rgba(255,255,255,0.8) 20%,
      rgba(255,255,255,0.4) 40%,
      rgba(255,255,255,0.4) 60%,
      rgba(255,255,255,0.8) 80%,
      white 100%
    );
  }
  
  .year-scroll-container:before, .year-scroll-container:after,
  .month-scroll-container:before, .month-scroll-container:after {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    height: 60px;
    pointer-events: none;
    z-index: 10;
  }
  
  .year-scroll-container:before, .month-scroll-container:before {
    top: 0;
    background: linear-gradient(to bottom, white, rgba(255,255,255,0));
  }
  
  .year-scroll-container:after, .month-scroll-container:after {
    bottom: 0;
    background: linear-gradient(to top, white, rgba(255,255,255,0));
  }
  
  .year-item, .month-item {
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    scroll-snap-align: center;
    color: #333;
  }
  
  .year-item.selected, .month-item.selected {
    color: #F44B74;
    font-weight: bold;
    font-size: 22px;
    overflow-y: auto;
  }
  
  .year-navigation {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding: 0 10px;
  }
  
  .year-nav-btn {
    background-color: #f5f5f5;
    border: none;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 14px;
    color: #333;
    cursor: pointer;
  }
  
  .year-nav-btn:hover {
    background-color: #eaeaea;
  }
  
  .year-selector.active, .month-selector.active {
    display: block;
  }
  
  .year-grid, .month-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    width: 100%;
    padding: 10px 0;
  }
  
  .year-item, .month-item {
    padding: 8px 0;
    text-align: center;
    font-size: 16px;
    cursor: pointer;
    border-radius: 8px;
    color: #333; /* Ensure text is black/dark */
  }
  
  .year-item:hover, .month-item:hover {
    background-color: #f0f0f0;
  }
  
  .year-item.selected, .month-item.selected {
    color: #F44B74;
    font-weight: bold;
  }
  
  .selected-month {
    cursor: pointer;
  }
  
  .nav-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: #555;
    cursor: pointer;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }
  
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 10px;
    width: 100%;
    margin-bottom: 30px;
  }
  
  .day {
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    cursor: pointer;
    border-radius: 50%;
    color: #333;
  }
  
  .day:hover {
    background-color: #f0f0f0;
  }
  
  .day.selected {
    background-color: #F44B74;
    color: white;
  }
  
  .save-btn {
    width: 100%;
    height: 50px;
    border-radius: 25px;
    border: none;
    background-color: #F44B74;
    color: white;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    margin-top: 10px;
    box-shadow: 0 4px 10px rgba(248, 92, 138, 0.3);
  }
  
  .cancel-btn {
    width: 100%;
    height: 40px;
    border-radius: 20px;
    border: none;
    background-color: transparent;
    color: #666;
    font-size: 14px;
    font-weight: 400;
    cursor: pointer;
    margin-top: 10px;
    display: none; /* Hide cancel button as per design */
  }
</style>

<!-- Date Picker Modal -->
<div class="date-picker-modal" id="birthday-picker-modal">
  <div class="date-picker-container">
    <div class="handle-bar"></div>
    <h2>Birthday</h2>
    
    <div class="year-month-selector">
      <div style="text-align: center; font-size: 16px;">
        <div class="selected-year" id="selected-year" onclick="toggleYearSelector()">2025</div>
        <div class="selected-month" id="selected-month" onclick="toggleMonthSelector()">July</div>
      </div>
    </div>
    
    <div class="year-selector" id="year-selector">
      <div class="selector-header">
        <button class="close-btn" onclick="toggleYearSelector()">Done</button>
      </div>
      <div class="selector-title">Select Year</div>
      <div class="year-scroll-container" id="year-scroll-container"></div>
    </div>
    
    <div class="month-selector" id="month-selector">
      <div class="selector-header">
        <button class="close-btn" onclick="toggleMonthSelector()">Done</button>
      </div>
      <div class="selector-title">Select Month</div>
      <div class="month-scroll-container" id="month-scroll-container"></div>
    </div>
    
    <div class="calendar-grid" id="calendar-grid">
      <!-- Calendar will be populated by JavaScript -->
    </div>
    
    <button class="save-btn" id="save-date-btn" onclick="saveDateSelection(); return false;">Save</button>
    <button class="cancel-btn" id="cancel-date-btn" onclick="closeModal(); return false;">Cancel</button>
  </div>
</div>

<script>
  // Global variables for user data
  let userId = null;
  let userProfileData = null;
  let selectedDate = null;
  let selectedFile = null;

  // Initialize when document is loaded
  document.addEventListener('DOMContentLoaded', async function() {
    // Initialize user data
    await initializeUser();
    
    // Set up event listeners for the form
    setupFormEventListeners();
  });

  // Initialize user data from Supabase or localStorage
  async function initializeUser() {
    try {
      // Try to get user from Supabase
      const { supabaseClientPromise } = await import('/js/supabase-client.js');
      const supabase = await supabaseClientPromise;
      
      const { data: { session }, error } = await supabase.auth.getSession();
      
      if (error) {
        console.error('Error getting session:', error);
        // Try getting user from localStorage as fallback
        const localUser = JSON.parse(localStorage.getItem('barcrush_user') || 'null');
        if (localUser && localUser.id) {
          userId = localUser.id;
          await loadUserProfile();
        } else {
          // Redirect to login if no user found
          window.location.href = '/views/login.html';
        }
      } else if (!session) {
        console.log('No active session found');
        // Try getting user from localStorage as fallback
        const localUser = JSON.parse(localStorage.getItem('barcrush_user') || 'null');
        if (localUser && localUser.id) {
          userId = localUser.id;
          await loadUserProfile();
        } else {
          // Redirect to login if no user found
          window.location.href = '/views/login.html';
        }
      } else {
        // User is authenticated
        userId = session.user.id;
        await loadUserProfile();
      }
    } catch (error) {
      console.error('Error initializing user:', error);
      // Try getting user from localStorage as fallback
      const localUser = JSON.parse(localStorage.getItem('barcrush_user') || 'null');
      if (localUser && localUser.id) {
        userId = localUser.id;
        await loadUserProfile();
      } else {
        // Redirect to login if no user found
        window.location.href = '/views/login.html';
      }
    }
  }

  // Load user profile data from Supabase
  async function loadUserProfile() {
    try {
      const { supabaseClientPromise } = await import('/js/supabase-client.js');
      const supabase = await supabaseClientPromise;
      
      const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', userId)
        .single();
      
      if (error) {
        console.error('Error fetching profile:', error);
        if (error.code === 'PGRST116') {
          // Profile doesn't exist yet, use empty data
          userProfileData = {};
          populateFormWithUserData(userProfileData);
          alert('No existing profile found. Please fill in your information.');
          return;
        }
        throw error;
      }
      
      if (!data || Object.keys(data).length === 0) {
        // No data returned
        alert('Could not load your profile information. Please fill in your details.');
        userProfileData = {};
        populateFormWithUserData(userProfileData);
        return;
      }
      
      console.log('Profile data loaded:', data);
      userProfileData = data;
      populateFormWithUserData(userProfileData);
    } catch (error) {
      console.error('Error loading profile data:', error);
      // Use empty data if loading fails
      userProfileData = {};
      populateFormWithUserData(userProfileData);
      alert('Failed to load your profile information. Please fill in your details or try again later.');
    }
  }

  // Populate form with user data
  function populateFormWithUserData(data) {
    console.log('Populating form with data:', data);
    
    // Set first name
    if (data.first_name) {
      document.getElementById('first-name').value = data.first_name;
    }
    
    // Set last name
    if (data.last_name) {
      document.getElementById('last-name').value = data.last_name;
    }
    
    // Set phone number
    if (data.phone_number) {
      document.getElementById('phone-number').value = data.phone_number;
    }
    
    // Set country code
    if (data.country_code) {
      document.getElementById('country-code-input').value = data.country_code;
      document.getElementById('selected-code').textContent = data.country_code;
    }
    
    // Set birthday
    if (data.birthday) {
      selectedDate = new Date(data.birthday);
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('birthday-btn').querySelector('span').textContent = 
        selectedDate.toLocaleDateString('en-US', options);
      document.getElementById('birthday-btn').classList.add('has-value');
    }
    
    // Set location
    if (data.location) {
      document.getElementById('location-btn').querySelector('span').textContent = data.location;
      document.getElementById('location-btn').classList.add('has-value');
    }
    
    // Set profile image
    if (data.profile_image_url) {
      document.getElementById('profile-image').src = data.profile_image_url;
    }
  }

  // Set up event listeners for the form
  function setupFormEventListeners() {
    // Photo upload
    const cameraBtn = document.querySelector('.camera-btn');
    cameraBtn.addEventListener('click', function() {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.onchange = handlePhotoUpload;
      fileInput.click();
    });

    // Location button
    const locationBtn = document.getElementById('location-btn');
    locationBtn.addEventListener('click', handleLocationSelection);

    // Confirm button
    const confirmBtn = document.getElementById('confirm-btn');
    confirmBtn.addEventListener('click', saveUserProfile);

    // Country dropdown
    const countrySelect = document.getElementById('country-select');
    countrySelect.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const countryDropdown = document.getElementById('country-dropdown');
      const isVisible = countryDropdown.style.display === 'block';
      
      if (isVisible) {
        countryDropdown.style.display = 'none';
        this.classList.remove('active');
      } else {
        countryDropdown.style.display = 'block';
        this.classList.add('active');
      }
    });

    // Close country dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const countryDropdown = document.getElementById('country-dropdown');
      const countrySelect = document.getElementById('country-select');
      if (!countrySelect.contains(event.target) && !countryDropdown.contains(event.target)) {
        countryDropdown.style.display = 'none';
        countrySelect.classList.remove('active');
      }
    });

    // Initialize countries dropdown
    populateCountries();
  }

  // Handle photo upload
  function handlePhotoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Validate file type
    if (!file.type.startsWith('image/')) {
      alert('Please select a valid image file.');
      return;
    }

    // Validate file size (5MB limit)
    if (file.size > 5 * 1024 * 1024) {
      alert('File size must be less than 5MB.');
      return;
    }

    selectedFile = file;
    
    // Preview the image
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('profile-image').src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  // Handle location selection
  async function handleLocationSelection() {
    if (navigator.geolocation) {
      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject);
        });
        
        const { latitude, longitude } = position.coords;
        
        // Use reverse geocoding to get location name
        try {
          const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=en`);
          const data = await response.json();
          const location = `${data.city}, ${data.countryName}`;
          document.getElementById('location-btn').querySelector('span').textContent = location;
          document.getElementById('location-btn').classList.add('has-value');
        } catch (error) {
          console.error('Error getting location name:', error);
          const location = `${latitude.toFixed(2)}, ${longitude.toFixed(2)}`;
          document.getElementById('location-btn').querySelector('span').textContent = location;
          document.getElementById('location-btn').classList.add('has-value');
        }
      } catch (error) {
        console.error('Error getting location:', error);
        // Fallback to manual entry
        const location = prompt('Please enter your location:');
        if (location) {
          document.getElementById('location-btn').querySelector('span').textContent = location;
          document.getElementById('location-btn').classList.add('has-value');
        }
      }
    } else {
      // Geolocation not supported, use manual entry
      const location = prompt('Please enter your location:');
      if (location) {
        document.getElementById('location-btn').querySelector('span').textContent = location;
        document.getElementById('location-btn').classList.add('has-value');
      }
    }
  }

  // Save user profile
  async function saveUserProfile() {
    const confirmBtn = document.getElementById('confirm-btn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Saving...';

    try {
      const { supabaseClientPromise } = await import('/js/supabase-client.js');
      const supabase = await supabaseClientPromise;

      // Validate required fields
      const firstName = document.getElementById('first-name').value;
      const lastName = document.getElementById('last-name').value;
      
      if (!firstName || !lastName) {
        alert('Please fill in your first and last name.');
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Confirm';
        return;
      }

      // Prepare profile data
      const profileData = {
        id: userId,
        first_name: firstName,
        last_name: lastName,
        phone_number: document.getElementById('phone-number').value,
        country_code: document.getElementById('country-code-input').value,
        location: document.getElementById('location-btn').querySelector('span').textContent,
        updated_at: new Date().toISOString()
      };

      // Add birthday if selected
      if (selectedDate) {
        profileData.birthday = selectedDate.toISOString().split('T')[0];
      }

      console.log('Saving profile data:', profileData);

      // Upload profile image if selected
      if (selectedFile) {
        const fileExt = selectedFile.name.split('.').pop();
        const fileName = `${userId}.${fileExt}`;
        
        const { error: uploadError } = await supabase.storage
          .from('avatars')
          .upload(fileName, selectedFile, { upsert: true });
        
        if (uploadError) {
          console.error('Error uploading image:', uploadError);
        } else {
          const { data: { publicUrl } } = supabase.storage
            .from('avatars')
            .getPublicUrl(fileName);
          profileData.profile_image_url = publicUrl;
        }
      }

      // Update profile in database
      const { error } = await supabase
        .from('profiles')
        .upsert(profileData);

      if (error) {
        throw error;
      }

      // Success feedback
      confirmBtn.textContent = 'Saved!';
      setTimeout(() => {
        window.location.href = '/discover';
      }, 1000);

    } catch (error) {
      console.error('Error saving profile:', error);
      alert('Error saving profile. Please try again.');
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'Confirm';
    }
  }

  // Populate countries dropdown
  async function populateCountries() {
    try {
      // Try to import countries from data directory first
      let countries;
      try {
        const module = await import('/js/data/countries.js');
        countries = module.countries;
      } catch (e) {
        // Fallback to direct import
        const module = await import('/js/countries.js');
        countries = module.countries;
      }
      
      const dropdown = document.querySelector('.country-list-container');
      if (!dropdown) return;
      
      dropdown.innerHTML = '';
      
      countries.forEach(country => {
        const option = document.createElement('div');
        option.className = 'country-option';
        option.innerHTML = `
          <span class="country-flag">${country.flag}</span>
          <span class="country-name">${country.name}</span>
          <span class="country-code">${country.dialCode}</span>
        `;
        option.addEventListener('click', () => selectCountry(country));
        dropdown.appendChild(option);
      });

      // Setup country search functionality
      const searchInput = document.getElementById('country-search-input');
      if (searchInput) {
        searchInput.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          const countryOptions = dropdown.querySelectorAll('.country-option');
          
          countryOptions.forEach(option => {
            const countryName = option.querySelector('.country-name').textContent.toLowerCase();
            if (countryName.includes(searchTerm)) {
              option.style.display = 'flex';
            } else {
              option.style.display = 'none';
            }
          });
        });
      }
    } catch (error) {
      console.error('Error loading countries:', error);
    }
  }

  // Select country
  function selectCountry(country) {
    document.getElementById('selected-flag').textContent = country.flag;
    document.getElementById('selected-code').textContent = country.dialCode;
    document.getElementById('country-code-input').value = country.dialCode;
    document.getElementById('country-dropdown').style.display = 'none';
  }

  // Global function to show date picker modal
  function showDatePicker() {
    console.log('showDatePicker called');
    const datePickerModal = document.getElementById('birthday-picker-modal');
    if (datePickerModal) {
      datePickerModal.style.display = 'flex';
      // Use a timeout to trigger the animation after display is set
      setTimeout(() => {
        datePickerModal.classList.add('visible');
      }, 10);
      initCalendar();
    } else {
      console.error('Date picker modal not found');
    }
  }
  
  // Toggle the year selector
  function toggleYearSelector() {
    const yearSelector = document.getElementById('year-selector');
    const monthSelector = document.getElementById('month-selector');
    const calendarGrid = document.getElementById('calendar-grid');
    const saveBtn = document.getElementById('save-date-btn');
    
    // Hide month selector if visible
    monthSelector.classList.remove('active');
    
    // Toggle year selector
    if (yearSelector.classList.contains('active')) {
      yearSelector.classList.remove('active');
      calendarGrid.style.display = 'grid';
      // Show the save button again
      saveBtn.style.display = 'block';
    } else {
      yearSelector.classList.add('active');
      calendarGrid.style.display = 'none';
      // Hide the save button
      saveBtn.style.display = 'none';
      
      // Populate the year scroller (Apple-style) dynamically
      populateYearScroller();
    }
  }
  
  // Toggle month selector
  function toggleMonthSelector() {
    const yearSelector = document.getElementById('year-selector');
    const monthSelector = document.getElementById('month-selector');
    const calendarGrid = document.getElementById('calendar-grid');
    const saveBtn = document.getElementById('save-date-btn');
    
    // Close year selector if open
    yearSelector.classList.remove('active');
    
    if (monthSelector.classList.contains('active')) {
      monthSelector.classList.remove('active');
      calendarGrid.style.display = 'grid';
      // Show the save button again
      saveBtn.style.display = 'block';
    } else {
      monthSelector.classList.add('active');
      calendarGrid.style.display = 'none';
      // Hide the save button
      saveBtn.style.display = 'none';
      populateMonthScroller();
    }
  }
  
  // Store the current decade view to support navigation
  window.currentDecadeView = null;
  
  // Populate the year scroller with Apple-style picker
  function populateYearScroller() {
    const yearContainer = document.getElementById('year-scroll-container');
    const currentYear = new Date().getFullYear();
    yearContainer.innerHTML = '';
    
    // Create a list of years starting from 18 years ago (legal age requirement)
    const maxYear = currentYear - 18; // Start from 18 years ago (legal age)
    const startYear = currentYear - 200; // Allow selection from 200 years ago
    
    // Add each year as a scrollable option, starting from 18 years ago
    for (let year = maxYear; year >= startYear; year--) {
      const yearItem = document.createElement('div');
      yearItem.classList.add('year-item');
      if (window.currentYear === year) {
        yearItem.classList.add('selected');
      }
      yearItem.setAttribute('data-year', year);
      yearItem.textContent = year;
      
      yearItem.addEventListener('click', function() {
        // Update selected year
        selectYear(year);
      });
      
      yearContainer.appendChild(yearItem);
    }
    
    // Add scroll event to handle selection based on scroll position
    yearContainer.addEventListener('scroll', function() {
      const containerRect = yearContainer.getBoundingClientRect();
      const containerCenter = containerRect.top + (containerRect.height / 2);
      
      // Find the item closest to center
      let closestItem = null;
      let closestDistance = Infinity;
      
      const yearItems = yearContainer.querySelectorAll('.year-item');
      yearItems.forEach(item => {
        const itemRect = item.getBoundingClientRect();
        const itemCenter = itemRect.top + (itemRect.height / 2);
        const distance = Math.abs(containerCenter - itemCenter);
        
        if (distance < closestDistance) {
          closestDistance = distance;
          closestItem = item;
        }
      });
      
      if (closestItem) {
        // Remove selected class from all items
        yearItems.forEach(item => item.classList.remove('selected'));
        
        // Add selected class to closest item
        closestItem.classList.add('selected');
        
        // Update the selected year (without closing the selector)
        const selectedYear = parseInt(closestItem.getAttribute('data-year'));
        if (window.currentYear !== selectedYear) {
          window.currentYear = selectedYear;
          document.getElementById('selected-year').textContent = selectedYear;
        }
      }
    });
    
    // Initial scroll to position the selected year in the middle
    setTimeout(() => {
      const selectedItem = yearContainer.querySelector('.year-item.selected');
      if (selectedItem) {
        selectedItem.scrollIntoView({ block: 'center' });
      }
    }, 100);
  }
  
  // Function to select a year
  function selectYear(year) {
    // Update the selected year
    window.currentYear = year;
    document.getElementById('selected-year').textContent = year;
    
    // Update the visual selection
    const yearItems = document.querySelectorAll('.year-item');
    yearItems.forEach(item => {
      if (parseInt(item.getAttribute('data-year')) === year) {
        item.classList.add('selected');
      } else {
        item.classList.remove('selected');
      }
    });
    
    // Close the year selector if we're not just scrolling
    document.getElementById('year-selector').classList.remove('active');
    
    // Show calendar grid
    document.getElementById('calendar-grid').style.display = 'grid';
    
    // Show save button if both year and month are selected (month is always selected by default)
    const saveBtn = document.getElementById('save-date-btn');
    if (window.currentYear !== null) {
      saveBtn.style.display = 'block';
    }
    
    // Update calendar days
    renderCalendarDays();
  }
  
  // Populate the month scroller with Apple-style picker
  function populateMonthScroller() {
    const monthContainer = document.getElementById('month-scroll-container');
    monthContainer.innerHTML = '';
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    
    // Add each month as a scrollable option
    monthNames.forEach((month, index) => {
      const monthItem = document.createElement('div');
      monthItem.classList.add('month-item');
      if (window.currentMonth === index) {
        monthItem.classList.add('selected');
      }
      monthItem.setAttribute('data-month-index', index);
      monthItem.textContent = month;
      
      monthItem.addEventListener('click', function() {
        // Update selected month
        selectMonth(index);
      });
      
      monthContainer.appendChild(monthItem);
    });
    
    // Add scroll event to handle selection based on scroll position
    monthContainer.addEventListener('scroll', function() {
      const containerRect = monthContainer.getBoundingClientRect();
      const containerCenter = containerRect.top + (containerRect.height / 2);
      
      // Find the item closest to center
      let closestItem = null;
      let closestDistance = Infinity;
      
      const monthItems = monthContainer.querySelectorAll('.month-item');
      monthItems.forEach(item => {
        const itemRect = item.getBoundingClientRect();
        const itemCenter = itemRect.top + (itemRect.height / 2);
        const distance = Math.abs(containerCenter - itemCenter);
        
        if (distance < closestDistance) {
          closestDistance = distance;
          closestItem = item;
        }
      });
      
      if (closestItem) {
        // Remove selected class from all items
        monthItems.forEach(item => item.classList.remove('selected'));
        
        // Add selected class to closest item
        closestItem.classList.add('selected');
        
        // Update the selected month (without closing the selector)
        const selectedMonthIndex = parseInt(closestItem.getAttribute('data-month-index'));
        if (window.currentMonth !== selectedMonthIndex) {
          window.currentMonth = selectedMonthIndex;
          document.getElementById('selected-month').textContent = monthNames[selectedMonthIndex];
        }
      }
    });
    
    // Initial scroll to position the selected month in the middle
    setTimeout(() => {
      const selectedItem = monthContainer.querySelector('.month-item.selected');
      if (selectedItem) {
        selectedItem.scrollIntoView({ block: 'center' });
      }
    }, 100);
  }
  
  // Function to select a month
  function selectMonth(monthIndex) {
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    
    // Update the selected month
    window.currentMonth = monthIndex;
    document.getElementById('selected-month').textContent = monthNames[monthIndex];
    
    // Update the visual selection
    const monthItems = document.querySelectorAll('.month-item');
    monthItems.forEach(item => {
      if (parseInt(item.getAttribute('data-month-index')) === monthIndex) {
        item.classList.add('selected');
      } else {
        item.classList.remove('selected');
      }
    });
    
    // Close the month selector if we're not just scrolling
    document.getElementById('month-selector').classList.remove('active');
    
    // Show calendar grid
    document.getElementById('calendar-grid').style.display = 'grid';
    
    // Show save button if both year and month are selected
    const saveBtn = document.getElementById('save-date-btn');
    if (window.currentYear !== null) {
      saveBtn.style.display = 'block';
    } else {
      saveBtn.style.display = 'none';
    }
    
    // Update calendar days
    renderCalendarDays();
  }
  
  // Initialize the calendar
  function initCalendar() {
    const today = new Date();
    const selectedYearEl = document.getElementById('selected-year');
    const selectedMonthEl = document.getElementById('selected-month');
    const saveBtn = document.getElementById('save-date-btn');
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    
    // Set the current month for the picker
    window.currentMonth = today.getMonth();
    
    // Default to 18 years ago - the legal age requirement
    window.currentYear = today.getFullYear() - 18;
    
    // Update month display with simple label
    selectedMonthEl.textContent = 'Select Month';
    // Show the default year (18 years ago)
    selectedYearEl.textContent = 'Select Year';
    
    // Always show the save button when in calendar view, regardless of selection state
    saveBtn.style.display = 'block';
    
    // Render days
    renderCalendarDays();
    
    // Initialize grids for year and month selectors
    populateYearGrid();
    populateMonthGrid();
    
    // Close modal when clicking outside of it
    const modal = document.getElementById('birthday-picker-modal');
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeModal();
      }
    });
    
    // Disable body scrolling when modal is open
    document.body.style.overflow = 'hidden';
  }
  
  // Render calendar days
  function renderCalendarDays() {
    const calendarGrid = document.getElementById('calendar-grid');
    calendarGrid.innerHTML = '';
    
    // Create days of the month
    const daysInMonth = new Date(window.currentYear, window.currentMonth + 1, 0).getDate();
    
    for (let i = 1; i <= daysInMonth; i++) {
      const dayElement = document.createElement('div');
      dayElement.classList.add('day');
      dayElement.textContent = i;
      
      // Check if this day is selected
      if (window.selectedDate && 
          window.selectedDate.getDate() === i && 
          window.selectedDate.getMonth() === window.currentMonth && 
          window.selectedDate.getFullYear() === window.currentYear) {
        dayElement.classList.add('selected');
      }
      
      // Add click handler
      dayElement.addEventListener('click', function() {
        selectDay(i);
      });
      
      calendarGrid.appendChild(dayElement);
    }
  }
  
  // Select a day
  function selectDay(day) {
    window.selectedDate = new Date(window.currentYear, window.currentMonth, day);
    
    // Update UI
    document.querySelectorAll('.day').forEach(el => {
      el.classList.remove('selected');
    });
    
    // Find the clicked day and add selected class
    const dayElements = document.querySelectorAll('.day');
    for (let i = 0; i < dayElements.length; i++) {
      if (parseInt(dayElements[i].textContent) === day) {
        dayElements[i].classList.add('selected');
        break;
      }
    }
  }
  
  // Global helper function to close the modal with animation
  function closeModal() {
    const datePickerModal = document.getElementById('birthday-picker-modal');
    datePickerModal.classList.remove('visible');
    
    // Wait for animation to finish before hiding
    setTimeout(() => {
      datePickerModal.style.display = 'none';
    }, 300); // Match the CSS transition duration
  }
  
  // Global function to save the date selection
  function saveDateSelection() {
    console.log('Save button clicked');
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    const birthdayBtn = document.getElementById('birthday-btn');
    
    if (window.selectedDate) {
      // Format the date as needed (e.g., July 11, 1998)
      const formattedDate = `${monthNames[window.selectedDate.getMonth()]} ${window.selectedDate.getDate()}, ${window.selectedDate.getFullYear()}`;
      
      // Update the button text to show selected date
      const birthdayBtnText = document.querySelector('.birthday-btn span');
      if (birthdayBtnText) {
        birthdayBtnText.textContent = formattedDate;
        console.log('Updated birthday button text to:', formattedDate);
      } else {
        console.error('Could not find birthday button span element');
      }
      
      // Store the date value for form submission
      birthdayBtn.setAttribute('data-birthday', window.selectedDate.toISOString().split('T')[0]);
      
      // Change button color to indicate it has a value
      birthdayBtn.classList.add('has-value');
    }
    
    // Close the modal with animation
    closeModal();
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Re-attach the event handler for the birthday button to ensure it works
    const birthdayButton = document.getElementById('birthday-btn');
    if (birthdayButton) {
      console.log('Attaching event handler to birthday button');
      birthdayButton.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Birthday button clicked');
        showDatePicker();
        return false;
      });
    } else {
      console.error('Birthday button not found');
    }
    
    // We'll configure the confirm button later
    
    // Handle profile image selection
    const cameraBtn = document.querySelector('.camera-btn');
    const profileImage = document.getElementById('profile-image');
    
    cameraBtn.addEventListener('click', function() {
      // Create a file input element
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      
      fileInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
          const reader = new FileReader();
          
          reader.onload = function(event) {
            profileImage.src = event.target.result;
            profileImage.style.display = 'block';
            const placeholder = document.querySelector('.profile-placeholder');
            if (placeholder) {
              placeholder.style.display = 'none';
            }
          };
          
          reader.readAsDataURL(e.target.files[0]);
        }
      });
      
      fileInput.click();
    });
    
    // Set up date picker navigation and save button handlers
    const datePickerModal = document.getElementById('birthday-picker-modal');
    const birthdayBtn = document.getElementById('birthday-btn');
    const saveBtn = document.getElementById('save-date-btn');
    const cancelBtn = document.getElementById('cancel-date-btn');
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    // Navigate to previous year - direct binding to the DOM elements
    document.getElementById('birthday-picker-modal').querySelector('.prev-btn').onclick = function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('Previous year button clicked');
      window.currentYear--;
      initCalendar();
      return false;
    };
    
    // Navigate to next year - direct binding to the DOM elements
    document.getElementById('birthday-picker-modal').querySelector('.next-btn').onclick = function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('Next year button clicked');
      window.currentYear++;
      // Don't allow future years beyond current year
      const currentYear = new Date().getFullYear();
      if (window.currentYear > currentYear) {
        window.currentYear = currentYear;
      }
      initCalendar();
      return false;
    };
    
    // No need to redefine closeModal and saveDateSelection functions here as they are now globally defined
    
    // Make sure the save button has a click handler in JavaScript too for extra compatibility
    saveBtn.addEventListener('click', function(e) {
      e.preventDefault();
      saveDateSelection();
      return false;
    });
    
    // Cancel date selection
    cancelBtn.addEventListener('click', function() {
      closeModal();
    });
    
    // Close when clicking outside the date picker
    datePickerModal.addEventListener('click', function(e) {
      // Check if the click was directly on the modal background (not its children)
      if (e.target === datePickerModal) {
        closeModal();
      }
    });
    
    // Add touch swipe down to close
    const container = datePickerModal.querySelector('.date-picker-container');
    let startY = 0;
    let moveY = 0;
    
    container.addEventListener('touchstart', function(e) {
      startY = e.touches[0].clientY;
    });
    
    container.addEventListener('touchmove', function(e) {
      moveY = e.touches[0].clientY - startY;
      
      // Only allow swiping down, not up
      if (moveY > 0) {
        container.style.transform = `translateY(${moveY}px)`;
        e.preventDefault();
      }
    });
    
    container.addEventListener('touchend', function() {
      // If swiped down enough, close the modal
      if (moveY > 100) {
        closeModal();
      } else {
        // Reset position
        container.style.transform = '';
      }
      moveY = 0;
    });
    
    // Handle form submission - updated to navigate to gender selection page
    const confirmBtn = document.querySelector('.confirm-btn');

    confirmBtn.addEventListener('click', function() {
      const firstName = document.getElementById('first-name').value;
      const lastName = document.getElementById('last-name').value;
      const birthday = birthdayBtn.getAttribute('data-birthday') || '';
      
      // Validate form (simple example)
      if (!firstName || !lastName) {
        alert('Please fill in all required fields');
        return;
      }
      
      // Store profile data in localStorage
      const userData = {
        firstName,
        lastName,
        birthday
      };
      
      console.log('Saving profile data:', userData);
      localStorage.setItem('userProfile', JSON.stringify(userData));
      
      // Navigate to gender selection page
      window.location.href = '#/profile-gender';
    });
    
    // Initialize country dropdown
    const countrySelect = document.getElementById('country-select');
    const countryDropdown = document.getElementById('country-dropdown');
    const countryCodeInput = document.getElementById('country-code-input');
    const phoneInput = document.getElementById('phone-number');
    const fullPhoneInput = document.getElementById('full-phone');
    
    // We're using hardcoded country options in the HTML now
    function populateCountries() {
      console.log('Using hardcoded country options');
      
      // Set default country to US
      setSelectedCountry({
        code: 'us',
        name: 'United States',
        dialCode: '+1',
        flag: 'ðŸ‡ºðŸ‡¸'
      });
      
      // Add click handlers to the country options
      const countryOptions = document.querySelectorAll('.country-option');
      countryOptions.forEach(option => {
        const code = option.getAttribute('data-country');
        const dialCode = option.getAttribute('data-code');
        const flag = option.getAttribute('data-flag');
        const name = option.querySelector('.country-option-name').textContent;
        
        option.addEventListener('click', function() {
          console.log(`Country selected: ${name} (${dialCode})`);
          setSelectedCountry({
            code: code,
            name: name,
            dialCode: dialCode,
            flag: flag
          });
          countryDropdown.style.display = 'none';
          countrySelect.classList.remove('active');
        });
      });
    }
    
    // Helper function to add a country option to the dropdown
    function addCountryOption(country, container) {
      console.log(`Adding country option: ${country.name} (${country.dialCode})`);
      const option = document.createElement('div');
      option.className = 'country-option';
      option.setAttribute('data-code', country.dialCode);
      option.setAttribute('data-country', country.code);
      option.setAttribute('data-flag', country.flag);
      
      option.innerHTML = `
        <div class="country-option-flag">${country.flag}</div>
        <div class="country-option-name">${country.name}</div>
        <div class="country-option-code">${country.dialCode}</div>
      `;
      
      option.addEventListener('click', function() {
        console.log(`Country selected: ${country.name} (${country.dialCode})`);
        setSelectedCountry(country);
        countryDropdown.classList.remove('show');
        countryDropdown.style.display = 'none';
        countrySelect.classList.remove('active');
      });
      
      container.appendChild(option);
    }
    
    // Helper function to set the selected country
    function setSelectedCountry(country) {
      console.log(`Setting selected country: ${country.name} (${country.dialCode})`);
      
      // Get the elements by ID
      const selectedFlag = document.getElementById('selected-flag');
      const selectedCode = document.getElementById('selected-code');
      
      // Update the elements
      if (selectedFlag) selectedFlag.textContent = country.flag;
      if (selectedCode) selectedCode.textContent = country.dialCode;
      if (countryCodeInput) countryCodeInput.value = country.dialCode;
      
      console.log('Country selection updated:', {
        flag: selectedFlag ? selectedFlag.textContent : 'not found',
        code: selectedCode ? selectedCode.textContent : 'not found',
        inputValue: countryCodeInput ? countryCodeInput.value : 'not found'
      });
      
      // Update full phone number
      updateFullPhoneNumber();
    }
    
    // Function to update the full phone number
    function updateFullPhoneNumber() {
      const phoneNumber = phoneInput.value.replace(/\D/g, ''); // Remove non-digits
      
      if (phoneNumber) {
        fullPhoneInput.value = `${countryCodeInput.value}${phoneNumber.startsWith('0') ? phoneNumber.substring(1) : phoneNumber}`;
      } else {
        fullPhoneInput.value = '';
      }
    }
    
    // Format phone number as user types (US format by default)
    function formatPhoneNumberInput(input) {
      // Get only digits from input
      let digits = input.value.replace(/\D/g, '');
      
      // Don't format if empty
      if (!digits) {
        input.value = '';
        return;
      }
      
      // Format based on length
      if (digits.length <= 3) {
        input.value = digits;
      } else if (digits.length <= 6) {
        input.value = digits.slice(0, 3) + '-' + digits.slice(3);
      } else {
        input.value = digits.slice(0, 3) + '-' + digits.slice(3, 6) + '-' + digits.slice(6, 10);
      }
      
      // Limit to 10 digits (plus formatting)
      if (digits.length > 10) {
        digits = digits.slice(0, 10);
        input.value = digits.slice(0, 3) + '-' + digits.slice(3, 6) + '-' + digits.slice(6);
      }
    }
    
    // Initialize dropdown state
    countryDropdown.classList.remove('show');
    
    // Update full phone number when phone input changes
    document.getElementById('phone-number').addEventListener('input', updateFullPhoneNumber);
    
    // Toggle country dropdown
    countrySelect.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      console.log('Country select clicked');
      const isVisible = countryDropdown.style.display === 'block';
      
      if (isVisible) {
        console.log('Hiding dropdown');
        countryDropdown.style.display = 'none';
        this.classList.remove('active');
      } else {
        console.log('Showing dropdown');
        countryDropdown.style.display = 'block';
        this.classList.add('active');
      }
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!countrySelect.contains(e.target) && !countryDropdown.contains(e.target)) {
        countryDropdown.classList.remove('show');
        countryDropdown.style.display = 'none';
        countrySelect.classList.remove('active');
      }
    });
    
    // Update full phone when phone input changes
    phoneInput.addEventListener('input', function() {
      formatPhoneNumberInput(this);
      updateFullPhoneNumber();
    });
    
    // Add focus/blur events to phone input to style country select
    phoneInput.addEventListener('focus', function() {
      countrySelect.classList.add('phone-focused');
    });
    
    phoneInput.addEventListener('blur', function() {
      countrySelect.classList.remove('phone-focused');
    });
    
    // Initialize countries dropdown
    console.log('Initializing countries dropdown...');
    populateCountries().then(() => {
      console.log('Countries dropdown initialized');
    }).catch(err => {
      console.error('Error initializing countries dropdown:', err);
    });
  });
</script>

<!-- Load profile modules -->
<script type="module" src="/js/profile-controller.js"></script>
<script type="module" src="/js/test-language-switch.js"></script>
<script type="module" src="/js/edit-profile.js"></script>

</body>
</html>
